# The Flutter tooling requires that developers have a version of Visual Studio
# installed that includes CMake 3.14 or later. You should not increase this
# version, as doing so will cause the plugin to fail to compile for some
# customers of the plugin.
cmake_minimum_required(VERSION 3.14)

# Project-level configuration.
set(PROJECT_NAME "unnu_ragl")
project(${PROJECT_NAME} LANGUAGES CXX)
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
# set(CMAKE_INSTALL_LIBDIR lib CACHE PATH "library install dir" FORCE)

set(CMAKE_INSTALL_PREFIX "${CMAKE_BINARY_DIR}/dist" CACHE STRING "Needed by cpuinfo and duckdb" FORCE) 
set(UNNU_RAG_LITE_SRC_DIR ${CMAKE_CURRENT_SOURCE_DIR}/../src)


set(BUILD_SHARED_LIBS OFF)
####################### tokenizers
set(MSGPACK_CXX17 ON CACHE BOOL "Using c++17 compiler" FORCE)
set(MSGPACK_USE_BOOST OFF CACHE BOOL "Use Boost libraried" FORCE)
set(SPM_ENABLE_SHARED OFF CACHE BOOL "Builds shared libaries in addition to static libraries." FORCE)
add_subdirectory("${UNNU_RAG_LITE_SRC_DIR}/tokenizers" "${CMAKE_CURRENT_BINARY_DIR}/tokenizers")

########################## CTranslate2
set(ENABLE_CPU_DISPATCH  OFF CACHE BOOL "Compile CPU kernels for multiple ISA and dispatch at runtime" FORCE)
set(WITH_MKL OFF CACHE BOOL "Compile with Intel MKL backend" FORCE)
set(OPENMP_RUNTIME "COMP" CACHE STRING "OpenMP runtime (INTEL, COMP, NONE)" FORCE)
set(WITH_OPENBLAS ON CACHE BOOL "Compile with OpenBLAS backend" FORCE)

set(BUILD_SHARED_LIBS OFF)
######################### cpuinfo
set(CPUINFO_LOG_LEVEL "fatal" CACHE STRING "Minimum logging level (info with lower severity will be ignored)" FORCE)
# set(CPUINFO_LOG_TO_STDIO OFF CACHE BOOL "Log errors, warnings, and information to stdout/stderr" FORCE)
set(CPUINFO_LIBRARY_TYPE "static" CACHE STRING "Type of cpuinfo library (shared, static, or default) to build" FORCE)
set(CPUINFO_BUILD_TOOLS OFF CACHE BOOL "Build command-line tools" FORCE)
set(CPUINFO_BUILD_UNIT_TESTS OFF CACHE BOOL "Build cpuinfo unit tests" FORCE)
set(CPUINFO_BUILD_MOCK_TESTS OFF CACHE BOOL "Build cpuinfo mock tests" FORCE)
set(CPUINFO_BUILD_BENCHMARKS OFF CACHE BOOL "Build cpuinfo micro-benchmarks" FORCE)
set(CPUINFO_BUILD_PKG_CONFIG OFF CACHE BOOL "Build pkg-config manifest" FORCE)

include_directories("${UNNU_RAG_LITE_SRC_DIR}/cpuinfo/include")
add_subdirectory("${UNNU_RAG_LITE_SRC_DIR}/cpuinfo" "${CMAKE_CURRENT_BINARY_DIR}/cpuinfo")
link_directories(${CMAKE_CURRENT_BINARY_DIR}/cpuinfo/$<CONFIG>)

##########################$
if(WITH_OPENBLAS)
	set(BUILD_SHARED_LIBS OFF)
	set(BUILD_STATIC_LIBS ON)
	######################## OpenBLAS
	set(BUILD_WITHOUT_LAPACK OFF CACHE BOOL "Do not build LAPACK and LAPACKE (Only BLAS or CBLAS)" FORCE)
	set(BUILD_TESTING OFF CACHE BOOL "Build LAPACK testsuite when building LAPACK" FORCE)
	# set(BUILD_STATIC_LIBS ON CACHE BOOL "Build static library" FORCE)
	set(USE_OPENMP ON CACHE BOOL "Use compiler OpenMP" FORCE)
	set(NOFORTRAN ON CACHE BOOL "Not using Fortran Compiler" FORCE)
	# set(BUILD_SHARED_LIBS OFF CACHE BOOL "Build shared libraries" FORCE)
	set(C_LAPACK ON CACHE BOOL "Build LAPACK from C sources instead of the original Fortran" FORCE)
	include_directories("${CMAKE_BINARY_DIR}" "${CMAKE_BINARY_DIR}/generated")
	add_subdirectory("${UNNU_RAG_LITE_SRC_DIR}/OpenBLAS" "${CMAKE_CURRENT_BINARY_DIR}/blas" EXCLUDE_FROM_ALL)
	link_directories(${CMAKE_CURRENT_BINARY_DIR}/blas/lib/$<CONFIG>)
	set(OPENBLAS_INCLUDE_DIR "${CMAKE_CURRENT_BINARY_DIR}/generated")
	set(OPENBLAS_LIBRARY openblas)
endif()

# set(BUILD_SHARED_LIBS OFF)
####################### sentencepiece
# set(SPM_ENABLE_SHARED OFF CACHE BOOL "Builds shared libaries in addition to static libraries." FORCE)
# include_directories("${UNNU_RAG_LITE_SRC_DIR}/sentencepiece" "${CMAKE_CURRENT_BINARY_DIR}/sentencepiece")
# add_subdirectory("${UNNU_RAG_LITE_SRC_DIR}/sentencepiece" "${CMAKE_CURRENT_BINARY_DIR}/sentencepiece")
# link_directories(${CMAKE_CURRENT_BINARY_DIR}/sentencepiece/src/$<CONFIG>)

set(BUILD_SHARED_LIBS OFF)
######################### duckdb
if(CMAKE_GENERATOR_PLATFORM MATCHES "^arm64")
    set(DUCKDB_EXPLICIT_PLATFORM "windows_arm64" CACHE STRING "Set the platform for duckdb" FORCE) 
else()
    set(DUCKDB_EXPLICIT_PLATFORM "windows_amd64" CACHE STRING "Set the platform for duckdb" FORCE)
endif()
set(BUILD_MAIN_DUCKDB_LIBRARY 1 CACHE BOOL "Build the main duckdb library and executable." FORCE)
set(BUILD_CLI 0 CACHE BOOL "Compile the clients" FORCE)
set(GENERATE_EXTENSION_ENTRIES 1 CACHE BOOL "Build for generating extension_entries.hpp" FORCE)
set(BUILD_UNITTESTS OFF CACHE BOOL "Build the C++ Unit Tests." FORCE)
set(EXTENSION_STATIC_BUILD 1 CACHE BOOL "Extension build linking statically with DuckDB. Required for building linux loadable extensions." FORCE)
set(ENABLE_EXTENSION_AUTOLOADING 1 CACHE BOOL "Enable extension auto-loading by default." FORCE)
set(ENABLE_EXTENSION_AUTOINSTALL 1 CACHE BOOL "Enable extension auto-installing by default." FORCE)
set(BUILD_SHELL 0 CACHE BOOL "Build the DuckDB Shell and SQLite API Wrappers" FORCE)

include_directories("${UNNU_RAG_LITE_SRC_DIR}/duckdb/include" "${CMAKE_CURRENT_BINARY_DIR}/duckdb/codegen/include")
add_subdirectory("${UNNU_RAG_LITE_SRC_DIR}/duckdb" "${CMAKE_CURRENT_BINARY_DIR}/duckdb")
link_directories(${CMAKE_CURRENT_BINARY_DIR}/duckdb/src/$<CONFIG>
			${CMAKE_CURRENT_BINARY_DIR}/duckdb/extension/core_functions/$<CONFIG>
			${CMAKE_CURRENT_BINARY_DIR}/duckdb/extension/icu/$<CONFIG>
			${CMAKE_CURRENT_BINARY_DIR}/duckdb/extension/parquet/$<CONFIG>
			${CMAKE_CURRENT_BINARY_DIR}/duckdb/extension/json/$<CONFIG>
			${CMAKE_CURRENT_BINARY_DIR}/duckdb/extension/fts/$<CONFIG>
			${CMAKE_CURRENT_BINARY_DIR}/duckdb/extension/vss/$<CONFIG>
			${CMAKE_CURRENT_BINARY_DIR}/duckdb/extension/sqlite/$<CONFIG>
			${CMAKE_CURRENT_BINARY_DIR}/duckdb/third_party/fastpforlib/$<CONFIG>
			${CMAKE_CURRENT_BINARY_DIR}/duckdb/third_party/fmt/$<CONFIG>
			${CMAKE_CURRENT_BINARY_DIR}/duckdb/third_party/fsst/$<CONFIG>
			${CMAKE_CURRENT_BINARY_DIR}/duckdb/third_party/hyperloglog/$<CONFIG>
			${CMAKE_CURRENT_BINARY_DIR}/duckdb/third_party/libpg_query/$<CONFIG>
			${CMAKE_CURRENT_BINARY_DIR}/duckdb/third_party/mbedtls/$<CONFIG>
			${CMAKE_CURRENT_BINARY_DIR}/duckdb/third_party/miniz/$<CONFIG>
			${CMAKE_CURRENT_BINARY_DIR}/duckdb/third_party/re2/$<CONFIG>
			${CMAKE_CURRENT_BINARY_DIR}/duckdb/third_party/skiplist/$<CONFIG>
			${CMAKE_CURRENT_BINARY_DIR}/duckdb/third_party/utf8proc/$<CONFIG>
			${CMAKE_CURRENT_BINARY_DIR}/duckdb/third_party/yyjson/$<CONFIG>
			${CMAKE_CURRENT_BINARY_DIR}/duckdb/third_party/zstd/$<CONFIG>)

set(DUCKDB_EXT_LIBRARIES 
			core_functions_extension 
			fts_extension 
			icu_extension 
			json_extension 
			parquet_extension 
			sqlite_scanner_extension
			vss_extension)
			
set(DUCKDB_3RDPARTY_LIBRARIES
			duckdb_fastpforlib
			duckdb_fmt
			duckdb_fsst
			duckdb_hyperloglog
			duckdb_pg_query
			duckdb_mbedtls
			duckdb_miniz
			duckdb_re2
			duckdb_skiplistlib
			duckdb_utf8proc
			duckdb_yyjson
			duckdb_zstd)


set(BUILD_SHARED_LIBS ON)
########################## CTranslate2
include_directories("${UNNU_RAG_LITE_SRC_DIR}/CTranslate2/include")
add_subdirectory("${UNNU_RAG_LITE_SRC_DIR}/CTranslate2" "${CMAKE_CURRENT_BINARY_DIR}/ct2")
link_directories(${CMAKE_CURRENT_BINARY_DIR}/ct2/$<CONFIG>)

# Invoke the build for native code shared with the other target platforms.
# This can be changed to accommodate different builds.
add_subdirectory("${UNNU_RAG_LITE_SRC_DIR}" "${CMAKE_CURRENT_BINARY_DIR}/shared")

# List of absolute paths to libraries that should be bundled with the plugin.
# This list could contain prebuilt libraries, or libraries created by an
# external build triggered from this build file.
set(unnu_ragl_bundled_libraries
  # Defined in ../src/CMakeLists.txt.
  # This can be changed to accommodate different builds.
  $<TARGET_FILE:unnu_ragl>
  $<TARGET_FILE:ctranslate2>
  $<TARGET_FILE:duckdb>
  PARENT_SCOPE
)
